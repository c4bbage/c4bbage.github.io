<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="c4bbage">
  
  <title>尝试修复cobaltstrike xor64.bin(未完成) - c4bbage blog</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "尝试修复cobaltstrike xor64.bin(未完成)";
    var mkdocs_page_input_path = "cobaltstrike-xor.md";
    var mkdocs_page_url = "/cobaltstrike-xor/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> c4bbage blog</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>工作笔记</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../paloalto2elk1/">paloalto日志转发elk1</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../paloalto2elk2/">paloalto日志转发elk2</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>兴趣关注</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../cve-2017-7269tips/">CVE-2017-7269的几个技巧及BUG修正</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../spear%20Phishing%20Techniques%20used%20in%20attacks%20targeting%20the%20MongolianGovernment/">针对蒙古国的apt攻击[翻译]</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../yunshu_aliyun/">阿里云用户隔离-云舒文章</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../How_to_spend_the_workplace_arsenal/">如何度过职场新兵期-四哥</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../log4j-deserialization-vuln/">log4j deserialization vuln</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../doublepulsar-smb-implant-detection-from-and-eventlog-detection/">使用Volatility检测DoublePulsar SMB 和日志审查</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../CVE-2017-8759/">CVE-2017-8759 利用方法</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../sysmon_note/">sysmon 笔记</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../OfficeDDE/">office DDE 实战</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>过期老文</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../handle_csrf_token_with_burpsuite_or_sqlmap/">用Burpsuite 来处理csrf token</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>实用工具</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../debian8_install_msf/">debian8安装metasploit</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../msf_usage/">metasplit使用笔记</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../cobaltstrike_usage/">cobalt strike 杂记</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../pentest_tools/">在渗透中需要用的工具收集</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../reverse_engineering_tool/">逆向工程工具</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../cobalt-strike-cracked/">cobalt strike 3.7 破解</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>技巧笔记</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../.netcallshellcode/">.net 执行 shellcode</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../linux_persistence_note/">linux 密码记录(client/server)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../burpsuite-fuzz-chr/">利用burpsuite来进行Fuzz</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../windows_persistence_note/">windows后门自启动笔记</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>水文</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">尝试修复cobaltstrike xor64.bin(未完成)</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#cobaltstrike-xorbin-xor64bin">cobaltstrike xor.bin xor64.bin 分析</a></li>
                
                    <li><a class="toctree-l4" href="#_1">概述</a></li>
                
                    <li><a class="toctree-l4" href="#_2">调用位置</a></li>
                
                    <li><a class="toctree-l4" href="#_3">想法</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../Heart%20chicken%20soup/">心灵鸡汤</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about/">About</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">c4bbage blog</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>水文 &raquo;</li>
        
      
    
    <li>尝试修复cobaltstrike xor64.bin(未完成)</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="cobaltstrike-xorbin-xor64bin">cobaltstrike xor.bin xor64.bin 分析</h1>
<blockquote>
<p>未完成</p>
</blockquote>
<ul>
<li>作者:c4bbage</li>
<li>时间:2017.9.14</li>
<li>链接:http://dobest1.com/cobaltstrike-xor</li>
</ul>
<h2 id="_1">概述</h2>
<p>在cobaltstrike3.8中在资源里我们缺少xor64.bin文件，早期流传3.x中存在xor.bin不知道来自哪里(我看了下所有3.x中没有xor.bin，而且3.x的xor.bin和2.5的xor.bin并不一样)，但是这并不影响我们使用cobaltstrike。
没有xor64.bin永远美中不足。</p>
<h2 id="_2">调用位置</h2>
<p>所有代码是以3.8为例</p>
<pre><code class="java">// common.ArtifactUtils
public static byte[] XorEncode(byte[] data, String arch)
{
if (License.isTrial())
{
    CommonUtils.print_trial(&quot;Disabled &quot; + arch + &quot; payload stage encoding.&quot;);
    return data;
}
AssertUtils.Test(data.length &gt; 16384, &quot;XorEncode used on a stager (or some other small thing)&quot;);


AssertUtils.TestArch(arch);
if (&quot;x86&quot;.equals(arch))
{
    byte[] decoder = CommonUtils.pickOption(&quot;resources/xor.bin&quot;);
    byte[] payload = XorEncoder.encode(data);
    return CommonUtils.join(decoder, payload);
}
if (&quot;x64&quot;.equals(arch))
{
    byte[] decoder = CommonUtils.readResource(&quot;resources/xor64.bin&quot;);
    byte[] payload = XorEncoder.encode(data);
    return CommonUtils.join(decoder, payload);
}
return new byte[0];
}
</code></pre>

<p>在x86架构中采用的是pickOption读取xor.bin，以下是调用过程及部分主要函数。</p>
<pre><code class="java">// common.CommonUtils
public static byte[] pickOption(String file)
{
    List options = readOptions(file);
    byte[] result = (byte[])options.get(rand(options.size()));
    return result;
}
// readOptions方法
public static List readOptions(String file)
{
    LinkedList results = new LinkedList();
    try
    {
        byte[] data = readResource(file);
        DataInputStream in = new DataInputStream(new ByteArrayInputStream(data));
        while (in.available() &gt; 0)
        {
        // 读取四个字节，并返回一个int值。文件指针后移
        int len = in.readInt();
        // available 判断读写操作前先得知数据流里有多少个字节可以读取
        if (len &gt; in.available())
        {
            print_error(&quot;readOptions: &quot; + file + &quot; has bad length: &quot; + len + &quot; &gt; &quot; + in.available());
            return results;
        }
        byte[] next = new byte[len];
        // read()方法最多
        in.read(next);
        results.add(next);
        }
    }
    catch (IOException ioex)
    {
        MudgeSanity.logException(&quot;readOptions: &quot; + file, ioex, false);
    }
    return results;
}

// common.CommonUtils
public static byte[] readResource(String f)
{
    try
    {
        InputStream in = resource(f);
        if (in != null)
        {
        byte[] result = readAll(in);
        in.close();
        return result;
        }
        print_error(&quot;Could not find resource: &quot; + f);
    }
    catch (IOException ioex)
    {
        MudgeSanity.logException(&quot;readResource: &quot; + f, ioex, false);
    }
    return new byte[0];
}

public static InputStream resource(String f)
throws IOException
{
    if (new File(f).exists()) {
        return new FileInputStream(new File(f));
    }
    return CommonUtils.class.getClassLoader().getResourceAsStream(f);
}
</code></pre>

<h2 id="_3">想法</h2>
<p>整个流程只是简单的读取文件编码文件，流程简析如下:</p>
<ul>
<li>CommonUtils.pickOption("resources/xor.bin")</li>
<li>CommonUtils.readOptions()</li>
<li>CommonUtils.readResource() <code>X64 省略了前面操作</code></li>
<li>CommonUtils.resource()</li>
</ul>
<p>我对上面的代码做了摘取，进行了调试 readResource()的结果和pickOption的结果一样。
xor.bin x86 的数据结构是</p>
<pre><code class="c">struct xorbin{
    int length;
    unsigned char shellcode[];
};

/** xir.bin 3.8 HEX数据
0x00,  0x00,  0x00,  0x38,  0xFC,  0xE8,  0x00,  0x00,  0x00,  0x00,  0xEB,  0x2B,  0x5D,  0x8B,  0x45,  0x00,  0x83,  0xC5,  0x04,  0x8B,  0x4D,  0x00,  0x31,  0xC1,  0x83,  0xC5,  0x04,  0x55,  0x8B,  0x55,  0x00,  0x31,  0xC2,  0x89,  0x55,  0x00,  0x31,  0xD0,  0x83,  0xC5,  0x04,  0x83,  0xE9,  0x04,  0x31,  0xD2,  0x39,  0xD1,  0x74,  0x02,  0xEB,  0xE8,  0x58,  0xFF,  0xE0,  0xE8,  0xD0,  0xFF,  0xFF,  0xFF,
// 
0x00,  0x00,  0x00,  0x38 =&gt; 56
*/
</code></pre>

<p>在x64 xor64.bin没有length这一位(四字节)，只有shellcode部分。
想起以前都是用一个xor.bin，到这里了我们是不是可以干了</p>
<pre><code>0xFC,  0xE8,  0x00,  0x00,  0x00,  0x00,  0xEB,  0x2B,  0x5D,  0x8B,  0x45,  0x00,  0x83,  0xC5,  0x04,  0x8B,  0x4D,  0x00,  0x31,  0xC1,  0x83,  0xC5,  0x04,  0x55,  0x8B,  0x55,  0x00,  0x31,  0xC2,  0x89,  0x55,  0x00,  0x31,  0xD0,  0x83,  0xC5,  0x04,  0x83,  0xE9,  0x04,  0x31,  0xD2,  0x39,  0xD1,  0x74,  0x02,  0xEB,  0xE8,  0x58,  0xFF,  0xE0,  0xE8,  0xD0,  0xFF,  0xFF,  0xFF,
</code></pre>

<p>用C32修改xor.bin数据
把xor64.bin添加到jar中，生成64位的windows Executable，后来发现CS逻辑代码上，走不到到XorEncoder.encode(),X64系统中，也是走的x86体系的payload作为data数据，比如vncdll.x64.dll。
就先到这里，下次分析下2.5版本的xor.bin.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Heart%20chicken%20soup/" class="btn btn-neutral float-right" title="心灵鸡汤">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../windows_persistence_note/" class="btn btn-neutral" title="windows后门自启动笔记"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../windows_persistence_note/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Heart%20chicken%20soup/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
